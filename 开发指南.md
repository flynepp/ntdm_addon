# 视频网站标签状态记录插件 - 开发指南

> **项目状态**：✅ 已完成基础功能实现  
> **目标网站**：ntdm8.com  
> **功能范围**：首页周标签（周一~周日）的状态记录与恢复

## 项目背景
ntdm8.com 视频网站的周标签状态在页面刷新后会丢失，本插件实现了浏览器会话级的状态记录与自动恢复。

## 目标平台
- 主要：Microsoft Edge (基于 Chromium)
- 次要：Firefox (可选)

## 核心需求
1. 监听目标网站的标签状态变化
2. 将状态保存在浏览器会话存储中
3. 页面加载时自动恢复之前的状态
4. 关闭浏览器后自动清除所有记录

---

## 开发方案概述

### 一、技术架构选择

#### 1.1 插件类型
采用 **WebExtensions API**，这是一套跨浏览器的标准 API，可以同时支持 Chrome、Edge 和 Firefox。

#### 1.2 核心组件
- **Manifest 文件**：插件的配置文件，定义权限、脚本注入规则等
- **Content Script**：注入到目标网站页面中的脚本，负责监听和操作 DOM
- **Background Script/Service Worker**：后台脚本，负责数据存储和跨页面通信
- **Storage API**：使用 `sessionStorage` 或浏览器的 `chrome.storage.session` API

---

### 二、工作流程

#### 2.1 状态监听
1. Content Script 注入到目标网站
2. 使用 DOM 观察器（MutationObserver）或事件监听器捕获标签状态变化
3. 识别哪些元素代表"标签"及其状态（选中、未选中等）

#### 2.2 状态存储
1. 当检测到状态变化时，将数据发送给 Background Script
2. Background Script 将状态存储到 `sessionStorage`（会话级别存储）
3. 存储格式：`{ url: 页面URL, tabStates: { ... } }`

#### 2.3 状态恢复
1. 页面加载时，Content Script 向 Background Script 请求已保存的状态
2. 如果存在匹配当前 URL 的状态记录，则恢复标签状态
3. 通过 JavaScript 操作 DOM，模拟用户点击或直接修改元素状态

#### 2.4 数据清理
- 使用 `sessionStorage` 自然特性：浏览器关闭后自动清除
- 或监听浏览器关闭事件，手动清理 `chrome.storage.session`

---

### 三、开发步骤

#### 第一阶段：环境搭建
1. 创建项目文件夹结构
2. 初始化 manifest.json 配置文件
3. 配置目标网站的匹配规则

#### 第二阶段：基础功能开发
1. 编写 Content Script 实现 DOM 注入
2. 实现状态检测逻辑（分析目标网站的 HTML 结构）
3. 实现状态存储逻辑
4. 实现状态恢复逻辑

#### 第三阶段：通信机制
1. 建立 Content Script 与 Background Script 的消息传递
2. 实现数据的读取和写入接口

#### 第四阶段：测试与优化
1. 在 Edge 开发者模式下加载测试
2. 验证状态记录和恢复的准确性
3. 处理边界情况（页面未完全加载、网络延迟等）

#### 第五阶段：跨浏览器适配（可选）
1. 测试 Firefox 兼容性
2. 使用 polyfill 处理 API 差异
3. 调整 manifest 文件版本

---

### 四、关键技术点

#### 4.1 内容脚本注入时机
- `document_start`：DOM 构建前注入
- `document_end`：DOM 构建后、资源加载前注入（推荐）
- `document_idle`：页面完全加载后注入

#### 4.2 状态存储方案对比
| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| sessionStorage | 简单，自动清理 | 仅限同一标签页 | 单页面应用 |
| chrome.storage.session | 跨标签页共享 | 需要 API 权限 | 多标签页场景 |
| chrome.storage.local | 持久化存储 | 需手动清理 | 不符合需求 |

**推荐方案**：`chrome.storage.session`（Edge 和 Firefox 均支持）

#### 4.3 DOM 变化监听策略
- **方案 A**：MutationObserver 监听整个容器的变化
- **方案 B**：直接监听标签元素的点击事件
- **方案 C**：定时轮询检查状态（不推荐，性能差）

**推荐方案**：方案 B + 方案 A 的组合

#### 4.4 状态识别方法
1. 分析目标网站的 HTML 结构
2. 找到标签元素的 CSS 类名或属性
3. 确定如何判断标签的"选中"状态（class、aria-selected、data-* 属性等）
4. 设计一个唯一标识符系统来区分不同的标签

---

### 五、潜在挑战与解决方案

#### 5.1 动态加载的内容
**问题**：某些网站使用 AJAX/Fetch 动态加载标签内容  
**解决**：使用 MutationObserver 监听 DOM 树变化，延迟恢复状态

#### 5.2 单页应用（SPA）路由
**问题**：URL 变化但页面不刷新（如 React Router）  
**解决**：监听 `popstate` 和 `pushState` 事件，检测路由变化

#### 5.3 网站结构变化
**问题**：网站更新可能改变 DOM 结构  
**解决**：使用灵活的选择器策略，添加容错机制

#### 5.4 性能优化
**问题**：频繁的状态保存可能影响性能  
**解决**：实现防抖（debounce）机制，批量保存状态

---

### 六、项目文件结构（预期）

```
ntdm_addon/
├── manifest.json           # 插件配置文件
├── icons/                  # 插件图标
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
├── content/                # 内容脚本
│   ├── content.js         # 主要的页面注入脚本
│   └── content.css        # 可选的样式文件
├── background/             # 后台脚本
│   └── background.js      # 状态存储和管理
├── popup/                  # 可选的弹出窗口
│   ├── popup.html
│   ├── popup.js
│   └── popup.css
└── utils/                  # 工具函数
    └── storage.js         # 存储相关的通用函数
```

---

### 七、开发工具与资源

#### 7.1 开发环境
- **代码编辑器**：VS Code（推荐安装 Extension API 插件）
- **浏览器**：Edge Canary 或 Dev 版本（便于调试）
- **调试工具**：浏览器开发者工具 + 扩展管理页面

#### 7.2 文档资源
- MDN WebExtensions API 文档
- Chrome Extensions 官方文档（Edge 兼容）
- Firefox Extension Workshop

#### 7.3 测试流程
1. Edge：访问 `edge://extensions/`，开启开发者模式，加载解压缩的扩展
2. Firefox：访问 `about:debugging`，加载临时附加组件

---

## 已完成的功能

- ✅ 基础框架搭建（manifest、background、content scripts）
- ✅ 状态存储系统（chrome.storage.session）
- ✅ DOM 处理逻辑（针对 ntdm8.com 周标签）
- ✅ 多种监听机制（点击、MutationObserver、路由变化）
- ✅ 状态提取与恢复功能
- ✅ 防抖优化和日志系统

## 后续优化方向

1. **性能优化**：
   - 进一步优化 MutationObserver 的监听范围
   - 实现更智能的状态变化检测

2. **功能扩展**：
   - 支持更多页面的状态记录（如番剧详情页）
   - 添加配置界面，让用户选择是否启用
   - 支持状态历史记录（撤销/重做）

3. **兼容性**：
   - 测试 Firefox 兼容性
   - 处理网站结构更新的容错

4. **用户体验**：
   - 添加插件图标
   - 提供状态清除按钮
   - 显示当前保存的状态

---

*当前版本：v1.0.0 - 基础功能已实现*
